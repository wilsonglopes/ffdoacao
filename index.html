<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Doação - Feltro Fácil</title>

<script src="https://cdn.tailwindcss.com"></script>
<script src="https://sdk.mercadopago.com/js/v2"></script>

<style>
  body { font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; background:#FEF2F2; color:#1f2937; }
  .btn-primary { background:#800080; color:#fff; }
  .btn-primary:hover { background:#6b006b; }
  .selected-amount { background:#800080; color:#fff; border-color:#800080; }
  .loader { border-top-color:#800080; animation:spin 1s linear infinite; }
  @keyframes spin { to { transform: rotate(360deg); } }

  /* Fix SVG bug inside MercadoPago Brick (only inside container) */
  #mercadopago-brick-container svg,
  #mercadopago-brick-container svg[width=""],
  #mercadopago-brick-container svg[height=""] {
    width: 22px !important;
    height: 22px !important;
  }

  /* Small helpers */
  .hidden { display:none; }
  textarea { resize: vertical; }
</style>
</head>
<body>

<header class="py-6 bg-white/80 shadow-sm">
  <div class="container mx-auto px-4">
    <img src="logo-f.png" alt="Feltro Fácil" class="h-12 mx-auto" onerror="this.style.display='none'">
  </div>
</header>

<main class="max-w-2xl mx-auto p-6">
  <div class="bg-white rounded-xl shadow p-6">
    <h1 class="text-2xl font-bold text-center mb-2">Faça a sua contribuição</h1>
    <p class="text-center text-sm text-gray-600 mb-6">Ajude a Feltro Fácil a continuar criando conteúdo de qualidade.</p>

    <label class="block font-semibold mb-2">Escolha o valor</label>
    <div class="grid grid-cols-3 gap-3 mb-4">
      <button type="button" class="amount-btn border rounded py-3 font-semibold" data-amount="10">R$ 10</button>
      <button type="button" class="amount-btn border rounded py-3 font-semibold" data-amount="30">R$ 30</button>
      <button type="button" class="amount-btn border rounded py-3 font-semibold" data-amount="50">R$ 50</button>
    </div>

    <div class="relative mb-6">
      <span class="absolute left-4 top-3 text-gray-400">R$</span>
      <input id="custom-amount" type="number" min="5" placeholder="Outro valor (mínimo R$ 5)" class="w-full pl-12 pr-4 py-3 border rounded">
    </div>

    <div class="mb-6">
      <label class="block font-semibold mb-2">Método</label>
      <div class="flex gap-3">
        <button id="btn-mp" class="flex-1 py-3 rounded border selected-amount">Brasil (Pix/Cartão)</button>
        <button id="btn-stripe" class="flex-1 py-3 rounded border text-gray-600">Internacional (Stripe)</button>
      </div>
    </div>

    <div id="error-message" class="hidden mb-4 text-sm p-3 rounded border bg-red-50 text-red-700"></div>

    <button id="start-checkout-btn" class="w-full btn-primary py-3 rounded font-bold mb-4">Continuar para Pagamento</button>

    <div id="payment-container" class="hidden">
      <div id="loading-spinner" class="flex justify-center py-6 hidden">
        <div class="loader rounded-full border-4 border-gray-200 h-12 w-12"></div>
      </div>

      <div id="mercadopago-brick-container" class="min-h-[180px]"></div>
    </div>

  </div>
</main>

<script>
/* CONFIG */
const MP_PUBLIC_KEY = 'APP_USR-7c3fa8cf-7680-42a9-bcd7-388e72fbcfe6';
const STRIPE_PUBLIC_KEY = ''; /* not used in this file version */

/* state */
let currentAmount = 0;
let currentMethod = 'mp'; // 'mp' or 'stripe'
let mpInstance = null;
let paymentBrickController = null;

document.addEventListener('DOMContentLoaded', () => {
  try { mpInstance = new MercadoPago(MP_PUBLIC_KEY, { locale: 'pt-BR' }); } catch(e){ console.error(e); }

  // amount buttons
  document.querySelectorAll('.amount-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      currentAmount = Number(btn.dataset.amount);
      document.querySelectorAll('.amount-btn').forEach(b => b.classList.remove('selected-amount'));
      btn.classList.add('selected-amount');
      document.getElementById('custom-amount').value = '';
      resetPaymentForms();
    });
  });

  // custom input
  document.getElementById('custom-amount').addEventListener('input', (e) => {
    currentAmount = Number(e.target.value || 0);
    document.querySelectorAll('.amount-btn').forEach(b => b.classList.remove('selected-amount'));
    resetPaymentForms();
  });

  // method buttons
  document.getElementById('btn-mp').addEventListener('click', () => {
    currentMethod = 'mp';
    document.getElementById('btn-mp').classList.add('selected-amount');
    document.getElementById('btn-stripe').classList.remove('selected-amount');
    resetPaymentForms();
  });
  document.getElementById('btn-stripe').addEventListener('click', () => {
    currentMethod = 'stripe';
    document.getElementById('btn-stripe').classList.add('selected-amount');
    document.getElementById('btn-mp').classList.remove('selected-amount');
    resetPaymentForms();
  });

  // start
  document.getElementById('start-checkout-btn').addEventListener('click', initiateCheckout);
});

/* helper */
function showError(msg) {
  const el = document.getElementById('error-message');
  el.textContent = msg;
  el.classList.remove('hidden');
}
function hideError() {
  const el = document.getElementById('error-message');
  el.classList.add('hidden');
  el.textContent = '';
}
function resetPaymentForms() {
  document.getElementById('payment-container').classList.add('hidden');
  document.getElementById('start-checkout-btn').classList.remove('hidden');
  hideError();
  if (paymentBrickController && typeof paymentBrickController.unmount === 'function') {
    try { paymentBrickController.unmount(); } catch(e){ /* ignore */ }
    paymentBrickController = null;
  }
  document.getElementById('mercadopago-brick-container').innerHTML = '';
}

/* main flow */
async function initiateCheckout() {
  hideError();
  if (!currentAmount || isNaN(currentAmount) || currentAmount < 5) {
    showError('Por favor escolha um valor mínimo de R$ 5,00.');
    return;
  }

  document.getElementById('start-checkout-btn').classList.add('hidden');
  document.getElementById('payment-container').classList.remove('hidden');
  document.getElementById('loading-spinner').classList.remove('hidden');

  try {
    if (currentMethod === 'mp') {
      await renderMercadoPagoPreferenceFlow();
    } else {
      showError('Modo Stripe não implementado aqui.');
    }
  } catch (err) {
    console.error('initiateCheckout error', err);
    showError(err?.message || 'Erro ao iniciar pagamento.');
    document.getElementById('loading-spinner').classList.add('hidden');
    document.getElementById('start-checkout-btn').classList.remove('hidden');
  }
}

/* Preference flow: backend must create preference and return preferenceId */
async function renderMercadoPagoPreferenceFlow() {
  const container = document.getElementById('mercadopago-brick-container');
  container.innerHTML = '';
  container.classList.remove('hidden');

  // small delay to let the container paint (helps svg sizing)
  await new Promise(r => setTimeout(r, 60));

  // call backend to create preference
  const resp = await fetch('/.netlify/functions/create-mp-donation', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ amount: currentAmount })
  });

  if (!resp.ok) {
    let message = `Erro do servidor (${resp.status})`;
    try { const j = await resp.json(); if (j?.error) message = j.error; } catch(e){}
    throw new Error(message);
  }

  const { preferenceId } = await resp.json();
  if (!preferenceId) throw new Error('preferenceId não retornado pelo servidor.');

  // create Brick: preferenceId must be provided and mercadoPago block together
  const bricksBuilder = mpInstance.bricks();

  const settings = {
    initialization: { preferenceId: preferenceId },
    mercadoPago: { publicKey: MP_PUBLIC_KEY, locale: 'pt-BR' },
    customization: {
      paymentMethods: {
        ticket: "all",
        bankTransfer: "all",
        creditCard: "all",
        debitCard: "all"
      }
    },
    callbacks: {
      onReady: () => {
        document.getElementById('loading-spinner').classList.add('hidden');
      },
      onSubmit: async ({ formData }) => {
        // formData contains selected payment method info and payer email
        try {
          const body = {
            amount: currentAmount,
            payment_method_id: formData.payment_method_id || formData.paymentMethodId || null,
            email: (formData.payer && (formData.payer.email || formData.payer.email_address)) || ''
          };

          const payResp = await fetch('/.netlify/functions/criar_pagamento', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(body)
          });

          if (!payResp.ok) {
            let msg = `Erro criação pagamento (${payResp.status})`;
            try { const j = await payResp.json(); if (j?.error) msg = j.error; } catch(e){}
            alert(msg);
            return Promise.reject();
          }

          const payJson = await payResp.json();

          // if MP returns point_of_interaction.transaction_data -> PIX info
          const tx = payJson?.point_of_interaction?.transaction_data;
          if (tx && (tx.qr_code_base64 || tx.qr_code)) {
            // show QR
            document.body.innerHTML = `
              <div style="min-height:100vh;display:flex;align-items:center;justify-content:center;padding:40px;font-family:Inter,system-ui;">
                <div style="max-width:520px;width:100%;background:#fff;border-radius:12px;padding:24px;box-shadow:0 8px 30px rgba(0,0,0,0.06);text-align:center;">
                  <h2 style="margin-bottom:12px">Escaneie o QR Code para pagar</h2>
                  <div style="margin:18px 0;">
                    <img src="data:image/png;base64,${tx.qr_code_base64 || ''}" alt="QR Code" style="max-width:100%;height:auto;border-radius:8px;"/>
                  </div>
                  <p style="font-size:14px;color:#444;margin-bottom:8px">Código COPIA E COLA</p>
                  <textarea readonly style="width:100%;height:110px;padding:12px;border-radius:8px;border:1px solid #eee;font-size:13px">${tx.qr_code}</textarea>
                  <div style="margin-top:18px">
                    <a href="/" style="display:inline-block;padding:10px 18px;background:#800080;color:#fff;border-radius:8px;text-decoration:none">Voltar</a>
                  </div>
                </div>
              </div>
            `;
            return Promise.resolve();
          }

          // otherwise, if approved or redirect necessary, check for status or init_point
          if (payJson?.status === 'approved' || payJson?.status_detail) {
            alert('Pagamento processado. Status: ' + (payJson.status || 'ok'));
            return Promise.resolve();
          }

          // fallback: if payJson contains a point_of_interaction.redirect_url or init_point
          const redirectUrl = payJson?.point_of_interaction?.transaction_data?.external_resource_url || payJson?.init_point || payJson?.transaction_details?.external_resource_url;
          if (redirectUrl) {
            window.location.href = redirectUrl;
            return Promise.resolve();
          }

          // unknown: show raw response for debugging
          console.log('Resposta pagamento MP:', payJson);
          alert('Pagamento iniciado. Verifique seu e-mail ou mobile para concluir.');
          return Promise.resolve();

        } catch (e) {
          console.error('Erro onSubmit:', e);
          alert('Erro ao criar pagamento: ' + (e?.message || e));
          return Promise.reject();
        }
      },
      onError: (err) => {
        console.error('Brick error:', err);
        if (JSON.stringify(err).includes('width') || JSON.stringify(err).includes('height')) {
          // svg sizing warnings — already handled by CSS
          return;
        }
        showError('Erro ao carregar formulário de pagamento.');
      }
    }
  };

  // create the brick (this must receive mercadoPago + preferenceId together)
  try {
    paymentBrickController = await bricksBuilder.create('payment', 'mercadopago-brick-container', settings);
  } catch (e) {
    console.error('Erro criando Brick:', e);
    throw new Error('Falha ao inicializar o formulário de pagamento.');
  }
}
</script>

</body>
</html>
