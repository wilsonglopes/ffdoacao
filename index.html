<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Apoie a Feltro F√°cil - Doa√ß√£o Segura</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://sdk.mercadopago.com/js/v2"></script>
    <script src="https://js.stripe.com/v3/"></script>

    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #FEF2F2; }
        .bg-feltro-purple { background-color: #800080; } 
        .text-feltro-purple { color: #800080; }
        .border-feltro-purple { border-color: #800080; }
        .selected-amount { background-color: #800080; color: white; border-color: #800080; }
        .loader { border-top-color: #800080; animation: spinner 1.5s linear infinite; }
        @keyframes spinner { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>

<body class="text-stone-800">

<header class="bg-white/90 backdrop-blur-lg shadow-sm sticky top-0 z-50">
    <nav class="container mx-auto px-4 py-4 flex justify-center items-center">
        <img src="logo-f.png" alt="Logo Feltro F√°cil" class="h-12 w-auto" onerror="this.style.display='none'">
    </nav>
</header>

<main class="container mx-auto px-4 py-10 max-w-2xl">
<div class="bg-white p-6 md:p-8 rounded-xl shadow-lg border border-stone-100">

    <div class="text-center mb-8">
        <h1 class="text-2xl md:text-3xl font-bold text-gray-800">Fa√ßa a sua contribui√ß√£o</h1>
        <p class="text-stone-600 mt-2">Ajude a Feltro F√°cil a continuar criando conte√∫do de qualidade.</p>
    </div>

    <!-- Sele√ß√£o de valor -->
    <div class="mb-8">
        <label class="block text-sm font-semibold text-stone-700 mb-3">Escolha o valor da doa√ß√£o:</label>
        <div class="grid grid-cols-3 gap-4 mb-4">
            <button onclick="selectAmount(10)" class="amount-btn border-2 border-stone-200 rounded-lg py-3 font-semibold text-stone-600 hover:border-feltro-purple">R$ 10</button>
            <button onclick="selectAmount(30)" class="amount-btn border-2 border-stone-200 rounded-lg py-3 font-semibold text-stone-600 hover:border-feltro-purple">R$ 30</button>
            <button onclick="selectAmount(50)" class="amount-btn border-2 border-stone-200 rounded-lg py-3 font-semibold text-stone-600 hover:border-feltro-purple">R$ 50</button>
        </div>

        <div class="relative">
            <span class="absolute left-4 top-3.5 text-stone-500 font-semibold">R$</span>
            <input id="custom-amount" type="number" placeholder="Outro valor (m√≠nimo R$ 5)"
                class="w-full pl-12 pr-4 py-3 border-2 border-stone-200 rounded-lg focus:border-feltro-purple"
                oninput="selectAmount(this.value, true)">
        </div>
    </div>

    <!-- Escolha do m√©todo -->
    <div class="mb-8">
        <label class="block text-sm font-semibold text-stone-700 mb-3">Voc√™ est√° no Brasil ou no Exterior?</label>
        <div class="flex flex-col md:flex-row space-y-3 md:space-y-0 md:space-x-4">
            <button id="btn-mp" onclick="setMethod('mp')" 
                class="flex-1 py-4 px-4 border-2 rounded-lg font-semibold flex items-center justify-center gap-2 selected-amount">
                üáßüá∑ Brasil (Pix/Cart√£o)
            </button>

            <button id="btn-stripe" onclick="setMethod('stripe')" 
                class="flex-1 py-4 px-4 border-2 border-stone-200 rounded-lg font-semibold text-stone-600 hover:border-gray-400">
                üåç Internacional (Stripe)
            </button>
        </div>
    </div>

    <div id="error-message" class="hidden bg-red-50 text-red-600 p-3 rounded-md mb-4 text-sm text-center border border-red-200"></div>

    <button id="start-checkout-btn" onclick="initiateCheckout()" 
        class="w-full bg-feltro-purple text-white font-bold py-4 rounded-lg shadow-lg hover:bg-purple-800 text-lg">
        Continuar para Pagamento
    </button>

    <!-- √Årea onde os m√©todos aparecem -->
    <div id="payment-container" class="mt-8 hidden">
        <div id="loading-spinner" class="flex justify-center py-8 hidden">
            <div class="loader rounded-full border-4 border-gray-200 h-12 w-12"></div>
        </div>

        <div id="mercadopago-brick-container"></div>

        <form id="stripe-payment-form" class="hidden mt-4">
            <div id="stripe-payment-element"></div>
            <button id="stripe-submit" class="w-full bg-slate-900 text-white font-bold py-3 rounded-md hover:bg-slate-800">
                <span id="stripe-button-text">Pagar Agora</span>
            </button>
        </form>
    </div>

</div>
<div class="text-center mt-6 text-stone-500 text-xs">Ambiente Seguro ‚Ä¢ Processado por MercadoPago e Stripe</div>
</main>

<script>
/* -------------------------------------------------------
   CONFIG
------------------------------------------------------- */
const MP_PUBLIC_KEY = "APP_USR-7c3fa8cf-7680-42a9-bcd7-388e72fbcfe6";
const STRIPE_PUBLIC_KEY = "pk_live_51SZGWH2Yql6uVgx9IxgMYgwkkE5nfQtrwjJxFosvO9VImC4ph66AkTcxzffPhKKyaUBzVHLJKonFEOCNMNByaqfq00rkKnjZJU";

let currentAmount = 0;
let currentMethod = "mp";
let mpInstance = null;
let stripeInstance = null;
let paymentBrickController = null;

/* -------------------------------------------------------
   Inicializa√ß√£o dos SDKs
------------------------------------------------------- */
try {
    if (window.MercadoPago) mpInstance = new MercadoPago(MP_PUBLIC_KEY, { locale: "pt-BR" });
    if (window.Stripe) stripeInstance = Stripe(STRIPE_PUBLIC_KEY);
} catch (e) {
    console.error("Erro ao carregar SDK:", e);
}

/* -------------------------------------------------------
   Sele√ß√£o de valor
------------------------------------------------------- */
function selectAmount(val, custom = false) {
    currentAmount = parseFloat(val);

    document.querySelectorAll(".amount-btn").forEach(btn => {
        const v = parseFloat(btn.innerText.replace("R$ ", ""));
        if (!custom && v === currentAmount) {
            btn.classList.add("selected-amount");
            document.getElementById("custom-amount").value = "";
        } else {
            btn.classList.remove("selected-amount");
        }
    });

    resetCheckout();
}

/* -------------------------------------------------------
   M√©todo MP / Stripe
------------------------------------------------------- */
function setMethod(m) {
    currentMethod = m;

    document.getElementById("btn-mp").classList.toggle("selected-amount", m === "mp");
    document.getElementById("btn-stripe").classList.toggle("selected-amount", m === "stripe");

    resetCheckout();
}

/* -------------------------------------------------------
   Reset do Checkout
------------------------------------------------------- */
function resetCheckout() {
    document.getElementById("payment-container").classList.add("hidden");
    document.getElementById("start-checkout-btn").classList.remove("hidden");
    document.getElementById("error-message").classList.add("hidden");

    if (paymentBrickController) {
        paymentBrickController.unmount();
        paymentBrickController = null;
    }

    document.getElementById("mercadopago-brick-container").innerHTML = "";
    document.getElementById("stripe-payment-form").classList.add("hidden");
}

/* -------------------------------------------------------
   Iniciar checkout
------------------------------------------------------- */
async function initiateCheckout() {
    const err = document.getElementById("error-message");
    err.classList.add("hidden");

    if (!currentAmount || currentAmount < 5) {
        err.textContent = "Por favor, escolha um valor m√≠nimo de R$ 5,00.";
        err.classList.remove("hidden");
        return;
    }

    document.getElementById("start-checkout-btn").classList.add("hidden");
    document.getElementById("payment-container").classList.remove("hidden");
    document.getElementById("loading-spinner").classList.remove("hidden");

    try {
        currentMethod === "mp" ? await renderMercadoPago() : await renderStripe();
    } catch (e) {
        console.error(e);
        err.textContent = e.message;
        err.classList.remove("hidden");
        document.getElementById("loading-spinner").classList.add("hidden");
        document.getElementById("start-checkout-btn").classList.remove("hidden");
    }
}

/* -------------------------------------------------------
   Mercado Pago ‚Äî CORRIGIDO
------------------------------------------------------- */
async function renderMercadoPago() {
    if (!mpInstance) throw new Error("SDK MercadoPago n√£o carregado.");

    const res = await fetch("/.netlify/functions/create-mp-donation", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ amount: currentAmount })
    });

    const data = await res.json();
    if (!data.preferenceId) throw new Error("Erro ao criar pagamento.");

    console.log("Preference ID:", data.preferenceId);

    const bricksBuilder = mpInstance.bricks();

    paymentBrickController = await bricksBuilder.create("payment", "mercadopago-brick-container", {
        initialization: {
            preferenceId: data.preferenceId,
            amount: currentAmount
        },
        mercadoPago: {
            publicKey: MP_PUBLIC_KEY,
            locale: "pt-BR"
        },
        customization: {
            paymentMethods: {
