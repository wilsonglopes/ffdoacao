<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Apoie a Feltro F√°cil - Doa√ß√£o Segura</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://sdk.mercadopago.com/js/v2"></script>
  <script src="https://js.stripe.com/v3/"></script>

  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

  <style>
    body { font-family: 'Inter', sans-serif; background-color: #FEF2F2; }
    .bg-feltro-purple { background-color: #800080; }
    .selected-amount { background-color: #800080; color: white !important; border-color: #800080 !important; }
    .loader { border-top-color: #800080; animation: spinner 1.5s linear infinite; }
    @keyframes spinner { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
  </style>
</head>

<body class="text-stone-800">

<header class="bg-white/90 backdrop-blur-lg shadow-sm sticky top-0 z-50">
  <nav class="container mx-auto px-4 py-4 flex justify-center items-center">
    <img src="logo-f.png" class="h-12 w-auto">
  </nav>
</header>

<main class="container mx-auto px-4 py-10 max-w-2xl">
  <div class="bg-white p-6 md:p-8 rounded-xl shadow-lg border border-stone-100">

    <div class="text-center mb-8">
      <h1 class="text-2xl md:text-3xl font-bold text-gray-800">Fa√ßa a sua contribui√ß√£o</h1>
      <p class="text-stone-600 mt-2">Ajude a Feltro F√°cil a continuar criando conte√∫do de qualidade.</p>
    </div>

    <div class="mb-8">
      <label class="block text-sm font-semibold text-stone-700 mb-3">Escolha o valor da doa√ß√£o:</label>

      <div class="grid grid-cols-3 gap-4 mb-4">
        <button type="button" data-amount="10"
          class="amount-btn border-2 border-stone-200 rounded-lg py-3 font-semibold text-stone-600">
          R$ 10
        </button>

        <button type="button" data-amount="30"
          class="amount-btn border-2 border-stone-200 rounded-lg py-3 font-semibold text-stone-600">
          R$ 30
        </button>

        <button type="button" data-amount="50"
          class="amount-btn border-2 border-stone-200 rounded-lg py-3 font-semibold text-stone-600">
          R$ 50
        </button>
      </div>

      <div class="relative">
        <span class="absolute left-4 top-3.5 text-stone-500 font-semibold">R$</span>
        <input id="custom-amount" type="number" min="5"
          placeholder="Outro valor (m√≠nimo R$ 5)"
          class="w-full pl-12 pr-4 py-3 border-2 border-stone-200 rounded-lg">
      </div>
    </div>

    <div class="mb-8">
      <label class="block text-sm font-semibold text-stone-700 mb-3">Voc√™ est√° no Brasil ou no Exterior?</label>

      <div class="flex flex-col md:flex-row space-y-3 md:space-y-0 md:space-x-4">
        <button id="btn-mp" type="button" data-method="mp"
          class="flex-1 py-4 px-4 border-2 rounded-lg font-semibold selected-amount">
          üáßüá∑ Brasil (Pix/Cart√£o)
        </button>

        <button id="btn-stripe" type="button" data-method="stripe"
          class="flex-1 py-4 px-4 border-2 border-stone-200 text-stone-600 rounded-lg">
          üåç Internacional (Stripe)
        </button>
      </div>
    </div>

    <div id="error-message" class="hidden bg-red-50 text-red-600 p-3 rounded-md mb-4 text-sm text-center border border-red-200"></div>

    <button id="start-checkout-btn" type="button"
      class="w-full bg-feltro-purple text-white font-bold py-4 rounded-lg shadow-lg hover:bg-purple-800 text-lg">
      Continuar para Pagamento
    </button>

    <div id="payment-container" class="mt-8 hidden">
      <div id="loading-spinner" class="flex justify-center py-8 hidden">
        <div class="loader rounded-full border-4 border-gray-200 h-12 w-12"></div>
      </div>

      <div id="mercadopago-brick-container"></div>

      <form id="stripe-payment-form" class="hidden mt-4">
        <div id="stripe-payment-element"></div>
        <button id="stripe-submit"
          class="w-full bg-slate-900 text-white font-bold py-3 rounded-md hover:bg-slate-800">
          Pagar Agora
        </button>
      </form>
    </div>

  </div>

  <div class="text-center mt-6 text-stone-500 text-xs">
    Ambiente Seguro ‚Ä¢ Processado por MercadoPago e Stripe
  </div>
</main>

<script>
const MP_PUBLIC_KEY = "APP_USR-7c3fa8cf-7680-42a9-bcd7-388e72fbcfe6";
const STRIPE_PUBLIC_KEY = "pk_live_51SZGWH2Yql6uVgx9IxgMYgwkkE5nfQtrwjJxFosvO9VImC4ph66AkTcxzffPhKKyaUBzVHLJKonFEOCNMNByaqfq00rkKnjZJU";

let currentAmount = 0;
let currentMethod = "mp";
let mpInstance;
let stripeInstance;
let paymentBrickController;

document.addEventListener("DOMContentLoaded", () => {

  mpInstance = new MercadoPago(MP_PUBLIC_KEY, { locale: "pt-BR" });
  stripeInstance = Stripe(STRIPE_PUBLIC_KEY);

  const buttons = document.querySelectorAll(".amount-btn");
  buttons.forEach(b => {
    b.onclick = () => {
      currentAmount = Number(b.dataset.amount);
      buttons.forEach(x => x.classList.remove("selected-amount"));
      b.classList.add("selected-amount");
      document.getElementById("custom-amount").value = "";
    };
  });

  document.getElementById("custom-amount").oninput = (e) => {
    currentAmount = Number(e.target.value);
    buttons.forEach(x => x.classList.remove("selected-amount"));
  };

  document.getElementById("btn-mp").onclick = () => {
    currentMethod = "mp";
    document.getElementById("btn-mp").classList.add("selected-amount");
    document.getElementById("btn-stripe").classList.remove("selected-amount");
  };

  document.getElementById("btn-stripe").onclick = () => {
    currentMethod = "stripe";
    document.getElementById("btn-stripe").classList.add("selected-amount");
    document.getElementById("btn-mp").classList.remove("selected-amount");
  };

  document.getElementById("start-checkout-btn").onclick = () => {
    iniciarCheckout();
  };

  async function iniciarCheckout() {
    document.getElementById("start-checkout-btn").classList.add("hidden");
    document.getElementById("payment-container").classList.remove("hidden");
    document.getElementById("loading-spinner").classList.remove("hidden");

    if (currentMethod === "mp") {
      await renderMercadoPago();
    }
  }

  async function renderMercadoPago() {
    const bricksBuilder = mpInstance.bricks();

    paymentBrickController = await bricksBuilder.create(
      "payment",
      "mercadopago-brick-container",
      {
        initialization: {
          amount: currentAmount
        },
        mercadoPago: {
          publicKey: MP_PUBLIC_KEY,
          locale: "pt-BR"
        },
        customization: {
          paymentMethods: {
            ticket: "all",
            bankTransfer: "all",
            creditCard: "all",
            debitCard: "all"
          }
        },
        callbacks: {
          onReady: () => {
            console.log("Brick carregado");
            document.getElementById("loading-spinner").classList.add("hidden");
          },
          onSubmit: async (formData) => {
            try {
              const resp = await fetch("/.netlify/functions/criar_pagamento", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                  amount: currentAmount,
                  payment_method_id: formData.paymentMethodId,
                  email: formData.formData.payer.email
                })
              });

              const data = await resp.json();

              const qr = data.point_of_interaction.transaction_data.qr_code_base64;
              const pix = data.point_of_interaction.transaction_data.qr_code;

              document.body.innerHTML = `
                <div style="text-align:center;padding:40px;">
                  <h2>Escaneie o QR Code para pagar</h2>
                  <img src="data:image/png;base64,${qr}" style="width:300px;margin:20px auto;">
                  <p>C√≥digo copia e cola:</p>
                  <textarea style="width:100%;height:80px">${pix}</textarea>
                </div>
              `;

              return Promise.resolve();

            } catch (e) {
              console.log("ERRO SUBMIT:", e);
            }
          },
          onError: (error) => {
            console.error("Erro Brick:", error);
          }
        }
      }
    );
  }

});
</script>

</body>
</html>
