<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Doação</title>

<script src="https://cdn.tailwindcss.com"></script>
<script src="https://sdk.mercadopago.com/js/v2"></script>

<style>
body { font-family: Inter, sans-serif; background:#FEF2F2; }
.selected { background:#800080 !important; color:white !important; }
</style>
</head>

<body>

<div class="max-w-xl mx-auto mt-10 bg-white p-6 shadow rounded">

<h1 class="text-2xl font-bold text-center mb-6">Faça sua contribuição</h1>

<div class="grid grid-cols-3 gap-4 mb-4">
  <button class="vbtn p-3 border rounded" data-v="10">R$ 10</button>
  <button class="vbtn p-3 border rounded" data-v="30">R$ 30</button>
  <button class="vbtn p-3 border rounded" data-v="50">R$ 50</button>
</div>

<input id="custom" type="number" class="border w-full p-3 rounded mb-4" placeholder="Outro valor">

<button id="go" class="w-full bg-purple-700 text-white p-4 rounded font-bold">
  Continuar
</button>

<div id="erro" class="hidden text-red-600 mt-4 text-center"></div>

<div id="box" class="hidden mt-6">
  <div id="mp-brick"></div>
</div>

</div>

<script>
const mp = new MercadoPago("APP_USR-7c3fa8cf-7680-42a9-bcd7-388e72fbcfe6", { locale:"pt-BR" });

let amount = 0;

document.querySelectorAll(".vbtn").forEach(btn=>{
  btn.onclick = ()=>{
    amount = Number(btn.dataset.v);
    document.querySelectorAll(".vbtn").forEach(b=>b.classList.remove("selected"));
    btn.classList.add("selected");
    document.getElementById("custom").value="";
  };
});

document.getElementById("custom").oninput = e=>{
  amount = Number(e.target.value);
  document.querySelectorAll(".vbtn").forEach(b=>b.classList.remove("selected"));
};

document.getElementById("go").onclick = iniciar;

async function iniciar() {
  if (amount < 5) {
    erro("Valor mínimo é R$ 5");
    return;
  }

  const r = await fetch("/.netlify/functions/create-mp-preference", {
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body:JSON.stringify({ amount })
  });

  const j = await r.json();

  if (!j.preferenceId) {
    erro("Falha ao criar preferência");
    return;
  }

  mostrarBrick(j.preferenceId);
}

function erro(m) {
  const e = document.getElementById("erro");
  e.textContent = m;
  e.classList.remove("hidden");
}

async function mostrarBrick(preferenceId) {
  document.getElementById("box").classList.remove("hidden");

  const bricks = mp.bricks();

  await bricks.create("payment", "mp-brick", {
    initialization:{
      preferenceId
    },
    callbacks:{
      onSubmit: async ({ formData }) => {

        const r = await fetch("/.netlify/functions/criar_pagamento", {
          method:"POST",
          headers:{ "Content-Type":"application/json" },
          body:JSON.stringify({
            amount,
            payment_method_id: formData.payment_method_id,
            email: formData.payer.email
          })
        });

        const p = await r.json();

        const info = p.point_of_interaction?.transaction_data;
        if (!info) {
          alert("Erro ao gerar PIX");
          return;
        }

        document.body.innerHTML = `
          <div style="padding:40px;text-align:center;">
            <h2>Escaneie o QR Code</h2>
            <img src="data:image/png;base64,${info.qr_code_base64}" style="width:300px;margin:auto;">
            <p style="margin-top:20px;">${info.qr_code}</p>
          </div>
        `;
      }
    }
  });
}
</script>

</body>
</html>
