<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Apoie a Feltro F치cil</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://sdk.mercadopago.com/js/v2"></script>
  <script src="https://js.stripe.com/v3/"></script>

  <style>
    body { font-family: Inter, sans-serif; background:#FEF2F2; }
    .selected-amount { background:#800080 !important; color:#fff !important; border-color:#800080 !important; }
    .bg-feltro-purple { background:#800080; }
    .loader { border-top-color:#800080; animation:spin 1.2s linear infinite; }
    @keyframes spin { to { transform:rotate(360deg); } }
  </style>
</head>

<body>

<header class="bg-white shadow-sm p-4 flex justify-center">
  <img src="logo-f.png" class="h-12">
</header>

<main class="container mx-auto max-w-2xl mt-10 p-6 bg-white rounded-xl shadow">

  <h1 class="text-3xl font-bold text-center mb-2">Fa칞a a sua contribui칞칚o</h1>
  <p class="text-center text-gray-600 mb-8">Ajude a Feltro F치cil a continuar criando conte칰do de qualidade.</p>

  <label class="block font-semibold mb-2">Escolha o valor:</label>

  <div class="grid grid-cols-3 gap-4 mb-4">
    <button class="amount-btn border-2 py-3 rounded font-semibold" data-amount="10">R$ 10</button>
    <button class="amount-btn border-2 py-3 rounded font-semibold" data-amount="30">R$ 30</button>
    <button class="amount-btn border-2 py-3 rounded font-semibold" data-amount="50">R$ 50</button>
  </div>

  <div class="relative mb-8">
    <span class="absolute left-4 top-3 text-gray-500">R$</span>
    <input id="custom-amount" type="number" min="5"
      class="border-2 w-full pl-10 p-3 rounded" placeholder="Outro valor (m칤nimo R$ 5)">
  </div>

  <label class="block font-semibold mb-3">Voc칡 est치 no Brasil ou exterior?</label>

  <div class="flex gap-4 mb-8">
    <button id="btn-mp" class="flex-1 py-4 border-2 rounded font-semibold selected-amount">游游 Brasil</button>
    <button id="btn-stripe" class="flex-1 py-4 border-2 rounded font-semibold text-gray-600">游깴 Internacional</button>
  </div>

  <div id="error-message" class="hidden bg-red-100 text-red-700 p-3 rounded mb-4 text-center text-sm"></div>

  <button id="start-checkout-btn"
    class="w-full bg-feltro-purple text-white font-bold py-4 rounded-lg">
    Continuar para Pagamento
  </button>

  <div id="payment-container" class="hidden mt-6">
    <div id="loading-spinner" class="hidden flex justify-center py-8">
      <div class="loader border-4 border-gray-200 rounded-full h-12 w-12"></div>
    </div>

    <div id="mercadopago-brick-container"></div>
  </div>

</main>

<script>
const MP_PUBLIC_KEY = "APP_USR-7c3fa8cf-7680-42a9-bcd7-388e72fbcfe6";
const mp = new MercadoPago(MP_PUBLIC_KEY, { locale:"pt-BR" });

let currentAmount = 0;
let paymentBrickController;
let currentMethod = "mp";

document.querySelectorAll(".amount-btn").forEach(btn => {
  btn.onclick = () => {
    currentAmount = Number(btn.dataset.amount);
    document.querySelectorAll(".amount-btn").forEach(b => b.classList.remove("selected-amount"));
    btn.classList.add("selected-amount");
    document.getElementById("custom-amount").value = "";
  };
});

document.getElementById("custom-amount").oninput = e => {
  currentAmount = Number(e.target.value);
  document.querySelectorAll(".amount-btn").forEach(b => b.classList.remove("selected-amount"));
};

document.getElementById("btn-mp").onclick = () => {
  currentMethod = "mp";
  btn-mp.classList.add("selected-amount");
  btn-stripe.classList.remove("selected-amount");
};

document.getElementById("start-checkout-btn").onclick = () => iniciarCheckout();

async function iniciarCheckout() {
  if (!currentAmount || currentAmount < 5) {
    mostrarErro("Escolha um valor m칤nimo de R$ 5");
    return;
  }

  document.getElementById("start-checkout-btn").classList.add("hidden");
  document.getElementById("payment-container").classList.remove("hidden");
  document.getElementById("loading-spinner").classList.remove("hidden");

  await carregarBrickMP();
}

function mostrarErro(msg) {
  const el = document.getElementById("error-message");
  el.textContent = msg;
  el.classList.remove("hidden");
}

async function carregarBrickMP() {
  const bricks = mp.bricks();

  paymentBrickController = await bricks.create("payment", "mercadopago-brick-container", {
    initialization: {
      amount: currentAmount
    },
    callbacks: {
      onReady: () => {
        document.getElementById("loading-spinner").classList.add("hidden");
      },
      onSubmit: async ({ formData }) => {
        try {
          const resp = await fetch("/.netlify/functions/criar_pagamento", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              amount: currentAmount,
              payment_method_id: formData.payment_method_id,
              email: formData.payer.email
            })
          });

          const data = await resp.json();
          const info = data.point_of_interaction?.transaction_data;

          if (!info) {
            alert("Erro: MP n칚o retornou dados PIX.");
            return;
          }

          document.body.innerHTML = `
            <div style="padding:40px;text-align:center;">
              <h2>Escaneie o QR Code</h2>
              <img src="data:image/png;base64,${info.qr_code_base64}" style="width:300px;margin:20px auto;">
              <p>C칩digo copia e cola:</p>
              <textarea style="width:100%;height:90px">${info.qr_code}</textarea>
            </div>
          `;

        } catch (err) {
          console.log("ERRO SUBMIT:", err);
        }
      },
      onError: err => {
        console.log("Erro Brick:", err);
        mostrarErro("Falha ao carregar o pagamento.");
      }
    }
  });
}
</script>

</body>
</html>
